<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>जिला अध्यक्ष प्रवास कार्यक्रम डैशबोर्ड</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Custom Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Hindi:wght@400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        h1, h2, h3, .hindi-title {
            font-family: 'Tiro Devanagari Hindi', serif;
        }
        .orange-theme {
            --tw-bg-opacity: 1;
            background-color: rgb(251 146 60 / var(--tw-bg-opacity)); /* orange-400 */
        }
        .btn-primary {
            @apply inline-flex items-center justify-center px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-opacity-75 transition-transform transform hover:scale-105;
        }
        .tab-active {
            @apply border-orange-500 text-orange-600;
        }
        .tab-inactive {
            @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
        /* Card animations */
        .program-card {
            transition: all 0.3s ease-in-out;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        /* Slideshow styles */
        #slideshow-overlay {
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        .slideshow-card {
             animation: fadeIn 0.8s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fb923c; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="bg-white rounded-2xl shadow-lg p-6 mb-8 border-t-4 border-orange-500">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 hindi-title">जिला अध्यक्ष प्रवास कार्यक्रम</h1>
                <div class="flex items-center space-x-3 mt-4 md:mt-0">
                    <button id="slideshowBtn" class="btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm2 0v8h12V6H4zm1-3a1 1 0 00-1 1v1h14V5a1 1 0 00-1-1H5z"/></svg>
                        स्लाइड शो
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-programs" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">कार्यक्रम देखें</button>
                    <button id="tab-dashboard" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-inactive">एनालिटिक्स डैशबोर्ड</button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <main id="app-content">

            <!-- Programs View -->
            <div id="program-view">
                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row gap-4 items-center flex-wrap">
                    <h3 class="text-lg font-semibold text-gray-700 hindi-title">फ़िल्टर करें:</h3>
                    <select id="mandalFilter" class="w-full sm:w-auto bg-gray-100 border-2 border-gray-200 rounded-lg py-2 px-4 focus:outline-none focus:border-orange-400"></select>
                    <select id="typeFilter" class="w-full sm:w-auto bg-gray-100 border-2 border-gray-200 rounded-lg py-2 px-4 focus:outline-none focus:border-orange-400"></select>
                    <button id="resetFilters" class="w-full sm:w-auto text-sm text-gray-600 hover:text-orange-600 font-medium">रीसेट करें</button>
                    <button id="bulkDownloadBtn" class="btn-primary sm:ml-auto mt-2 sm:mt-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        बल्क रिपोर्ट डाउनलोड
                    </button>
                </div>

                <div id="program-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Program cards will be injected here -->
                </div>
                 <div id="loadingMessage" class="text-center py-10 text-gray-600 font-semibold">
                    कार्यक्रम लोड हो रहे हैं...
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-4xl font-bold text-orange-500" id="total-programs">0</h3><p class="text-gray-500 mt-1">कुल कार्यक्रम</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-4xl font-bold text-orange-500" id="total-mandals">0</h3><p class="text-gray-500 mt-1">कुल मंडलों में प्रवास</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-4xl font-bold text-orange-500" id="total-attendance">0</h3><p class="text-gray-500 mt-1">कुल उपस्थिति</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg"><canvas id="mandalsChart"></canvas></div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg"><canvas id="typesChart"></canvas></div>
                    <div class="col-span-1 lg:col-span-5 bg-white p-6 rounded-2xl shadow-lg"><canvas id="timelineChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4 modal">
        <div class="relative bg-white rounded-lg shadow-2xl w-11/12 h-5/6 max-w-6xl p-4 modal-content transform scale-95">
             <span id="closeModal" class="absolute -top-4 -right-4 text-white bg-orange-500 rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold cursor-pointer transition-transform hover:scale-110">&times;</span>
             <div class="w-full h-full flex flex-col">
                <div class="relative flex-grow h-full w-full flex items-center justify-center overflow-hidden">
                    <img id="modalImage" class="max-w-full max-h-full object-contain cursor-zoom-in" src="" alt="कार्यक्रम का बड़ा फोटो">
                </div>
                <div id="thumbnail-container" class="flex-shrink-0 pt-3 flex justify-center gap-2 overflow-x-auto">
                    <!-- Thumbnails will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Slideshow Overlay -->
    <div id="slideshow-overlay" class="fixed inset-0 z-50 hidden items-center justify-center p-8">
        <span id="closeSlideshow" class="absolute top-6 right-8 text-white text-5xl font-bold cursor-pointer transition-transform hover:scale-110">&times;</span>
        <div id="slideshow-content" class="w-full h-full">
            <!-- Slideshow card will be injected here -->
        </div>
        <div class="absolute bottom-5 left-1/2 -translate-x-1/2 flex items-center gap-4">
             <button id="slideshow-prev" class="text-white text-4xl p-2 rounded-full bg-black/30 hover:bg-black/50 transition-all">&#10094;</button>
             <button id="slideshow-pause-play" class="text-white text-3xl p-3 rounded-full bg-black/30 hover:bg-black/50 transition-all">
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
             </button>
             <button id="slideshow-next" class="text-white text-4xl p-2 rounded-full bg-black/30 hover:bg-black/50 transition-all">&#10095;</button>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4o78Xk4MGw48WSeBe5pmHyqWaJl3lPz18LcA0QCPZmpiNNmkHbJBJS_iX1s63JvhqbOFCrQEMRNeE/pub?output=csv';
        let programData = [];
        let filteredData = [];
        let slideshowData = [];
        let chartInstances = {};
        let slideshowInterval;
        let slideshowIndex = 0;
        let isSlideshowPaused = false;

        // DOM Elements
        const loadingMessage = document.getElementById('loadingMessage');
        const programGrid = document.getElementById('program-grid');
        const mandalFilter = document.getElementById('mandalFilter');
        const typeFilter = document.getElementById('typeFilter');
        
        // Initializer
        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
            loadData();
            initializeEventListeners();
        });

        function initializeTabs() {
            const tabs = document.querySelectorAll('[id^="tab-"]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const viewId = tab.id.replace('tab-', '') + '-view';
                    document.querySelectorAll('[id$="-view"]').forEach(view => view.classList.add('hidden'));
                    document.getElementById(viewId).classList.remove('hidden');
                    tabs.forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                    tab.classList.replace('tab-inactive', 'tab-active');
                });
            });
        }
        
        function initializeEventListeners() {
             document.getElementById('resetFilters').addEventListener('click', () => {
                mandalFilter.selectedIndex = 0;
                typeFilter.selectedIndex = 0;
                applyFilters();
            });
            document.getElementById('bulkDownloadBtn').addEventListener('click', downloadBulkPdf);
            mandalFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            
            // Modals
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('imageModal').addEventListener('click', (e) => {
                if(e.target.id === 'imageModal') closeModal();
            });
            document.getElementById('modalImage').addEventListener('click', (e) => {
                e.target.classList.toggle('cursor-zoom-in');
                e.target.classList.toggle('cursor-zoom-out');
                e.target.classList.toggle('scale-150');
            });

            // Slideshow
            document.getElementById('slideshowBtn').addEventListener('click', startSlideshow);
            document.getElementById('closeSlideshow').addEventListener('click', stopSlideshow);
            document.getElementById('slideshow-next').addEventListener('click', nextSlide);
            document.getElementById('slideshow-prev').addEventListener('click', prevSlide);
            document.getElementById('slideshow-pause-play').addEventListener('click', toggleSlideshowPause);
        }

        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                programData = robustParseCsv(csvText);
                filteredData = [...programData];
                
                if (programData.length > 0) {
                    loadingMessage.style.display = 'none';
                    renderProgramCards();
                    setupFilters();
                    processAndRenderDashboard();
                    generateSlideshowData(); // Generate initial slideshow data
                } else {
                    loadingMessage.innerText = 'कोई कार्यक्रम डेटा नहीं मिला।';
                }
            } catch (error) {
                console.error("Error loading data:", error);
                loadingMessage.innerText = 'डेटा लोड करने में त्रुटि हुई।';
            }
        }
        
        function robustParseCsv(csvText) {
            const lines = csvText.split(/\r\n|\n/);
            if (lines.length < 2) return [];

            // Sanitize headers
            const rawHeaders = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const headers = rawHeaders.map((h, index) => {
                let cleanHeader = h.trim().replace(/^"|"$/g, '');
                if (index === 0) {
                    cleanHeader = cleanHeader.replace(/^\uFEFF/, ''); // Remove BOM
                }
                return cleanHeader;
            });
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = (values[index] || '').trim().replace(/^"|"$/g, '');
                    });
                    data.push(obj);
                } else {
                    console.warn(`Skipping row due to column mismatch:`, lines[i]);
                }
            }
            return data;
        }

        function getDriveFileId(url) {
            if (!url) return null;
            const match = url.match(/id=([a-zA-Z0-9_-]+)/);
            return (match && match[1]) ? match[1] : null;
        }

        function renderProgramCards() {
            programGrid.innerHTML = '';
            if (filteredData.length === 0) {
                programGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">इस फ़िल्टर के लिए कोई परिणाम नहीं मिला।</p>`;
                return;
            }
            filteredData.forEach((program, index) => {
                const photoLinks = (program['कार्यक्रम के फोटो'] || '').split(',').map(link => link.trim()).filter(link => link);
                const card = document.createElement('div');
                card.className = 'program-card bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl hover:-translate-y-1';
                card.innerHTML = `
                    <div class="relative">
                        <img src="${photoLinks.length > 0 ? `https://drive.google.com/thumbnail?id=${getDriveFileId(photoLinks[0])}` : 'https://placehold.co/600x400/fdba74/a16207?text=फोटो+नहीं'}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/600x400/fdba74/a16207?text=फोटो+उपलब्ध+नहीं';" 
                             alt="${program['कार्यक्रम का नाम']}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-full">${photoLinks.length} फोटो</div>
                    </div>
                    <div class="p-5">
                        <p class="text-sm text-orange-600 font-semibold">${program['कार्यक्रम का प्रकार']}</p>
                        <h2 class="text-xl font-bold text-gray-800 mt-1 hindi-title">${program['कार्यक्रम का नाम']}</h2>
                        <p class="text-sm text-gray-500 mt-2"><strong>स्थान:</strong> ${program['मंडल का नाम']}, ${program['कार्यक्रम स्थान']}</p>
                        <p class="text-sm text-gray-500"><strong>दिनांक:</strong> ${program['कार्यक्रम दिनांक']}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <button class="view-photos-btn text-sm font-semibold text-orange-600 hover:text-orange-800" data-index="${index}">फोटो देखें</button>
                            <button class="download-pdf-btn btn-primary !py-1 !px-3 !text-sm" data-index="${index}">PDF</button>
                        </div>
                    </div>
                `;
                programGrid.appendChild(card);
            });
            
            programGrid.querySelectorAll('.view-photos-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const programIndex = parseInt(e.currentTarget.dataset.index);
                    const program = filteredData[programIndex];
                    const photoLinks = (program['कार्यक्रम के फोटो'] || '').split(',').map(link => link.trim()).filter(link => link);
                    openModal(photoLinks);
                });
            });
             programGrid.querySelectorAll('.download-pdf-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const programIndex = parseInt(e.currentTarget.dataset.index);
                    downloadPdf(filteredData[programIndex]);
                });
            });
        }
        
        function setupFilters() {
            const mandals = [...new Set(programData.map(p => p['मंडल का नाम']))].filter(Boolean).sort();
            const types = [...new Set(programData.map(p => p['कार्यक्रम का प्रकार']))].filter(Boolean).sort();
            
            mandalFilter.innerHTML = `<option value="">सभी मंडल</option>` + mandals.map(m => `<option value="${m}">${m}</option>`).join('');
            typeFilter.innerHTML = `<option value="">सभी प्रकार</option>` + types.map(t => `<option value="${t}">${t}</option>`).join('');
        }
        
        function applyFilters() {
            const selectedMandal = mandalFilter.value;
            const selectedType = typeFilter.value;

            filteredData = programData.filter(p => {
                const mandalMatch = !selectedMandal || p['मंडल का नाम'] === selectedMandal;
                const typeMatch = !selectedType || p['कार्यक्रम का प्रकार'] === selectedType;
                return mandalMatch && typeMatch;
            });
            renderProgramCards();
            generateSlideshowData(); // Regenerate slideshow data based on filters
        }

        // --- Modal ---
        function openModal(photoLinks) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const thumbnailContainer = document.getElementById('thumbnail-container');
            
            if (photoLinks.length === 0) return;
            
            thumbnailContainer.innerHTML = '';
            photoLinks.forEach((link, index) => {
                const fileId = getDriveFileId(link);
                if (!fileId) return;
                const thumb = document.createElement('img');
                thumb.src = `https://drive.google.com/thumbnail?id=${fileId}`;
                thumb.className = 'h-16 w-16 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-orange-500';
                thumb.onclick = () => setActiveThumbnail(index);
                thumbnailContainer.appendChild(thumb);
            });
            
            function setActiveThumbnail(index) {
                const fileId = getDriveFileId(photoLinks[index]);
                modalImage.src = `https://lh3.googleusercontent.com/d/${fileId}`;
                modalImage.onerror = () => { modalImage.src = 'https://placehold.co/800x600/1e293b/94a3b8?text=फोटो+उपलब्ध+नहीं'; };
                thumbnailContainer.querySelectorAll('img').forEach((img, i) => {
                    img.classList.toggle('border-orange-500', i === index);
                });
            }
            
            setActiveThumbnail(0);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
            const modalImage = document.getElementById('modalImage');
            modalImage.classList.remove('cursor-zoom-out', 'scale-150');
            modalImage.classList.add('cursor-zoom-in');
        }

        // --- PDF Download ---
        async function imageUrlToDataUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error(`Could not convert image ${url} to data URL:`, error);
                return null;
            }
        }

        async function downloadPdf(program) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const photoLinks = (program['कार्यक्रम के फोटो'] || '').split(',').map(link => link.trim()).filter(link => link);
            let photoHtml = '';

            if (photoLinks.length > 0 && getDriveFileId(photoLinks[0])) {
                const imageUrl = `https://drive.google.com/thumbnail?id=${getDriveFileId(photoLinks[0])}`;
                const dataUrl = await imageUrlToDataUrl(imageUrl);
                if (dataUrl) {
                    photoHtml = `<img src="${dataUrl}" style="max-width: 150px; margin-bottom: 15px; border-radius: 8px;" />`;
                }
            }

            const element = document.createElement('div');
            element.style.width = '210mm';
            element.style.padding = '20px';
            element.style.backgroundColor = 'white';
            element.innerHTML = `
                ${photoHtml}
                <h1 style="font-size: 24px; color: #f97316; border-bottom: 2px solid #fb923c; padding-bottom: 10px; margin-bottom: 20px;">${program['कार्यक्रम का नाम']}</h1>
                <p><strong>दिनांक:</strong> ${program['कार्यक्रम दिनांक']}</p>
                <p><strong>स्थान:</strong> ${program['कार्यक्रम स्थान']}</p>
                <p><strong>मंडल:</strong> ${program['मंडल का नाम']}</p>
                <p><strong>प्रकार:</strong> ${program['कार्यक्रम का प्रकार']}</p>
                <p><strong>कुल उपस्थिति:</strong> ${program['कार्यक्रम में कुल उपस्तिथि']}</p>
                <p><strong>प्रमुख अतिथि:</strong> ${program['कार्यक्रम में प्रमुख अतिथि , जनप्रतिनिधि']}</p>
                <p style="margin-top: 20px;"><strong>विवरण:</strong> ${program['कार्यक्रम से सम्बंधित अन्य जानकारी संषिप्त में']}</p>
            `;
            document.body.appendChild(element);

            try {
                const canvas = await html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${program['कार्यक्रम का नाम']}.pdf`);
            } catch (error) {
                console.error("PDF generation error:", error);
                alert("PDF बनाने में त्रुटि हुई।");
            } finally {
                document.body.removeChild(element);
            }
        }

        async function downloadBulkPdf() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const element = document.createElement('div');
            
            let reportHtml = `
                <div style="font-family: Arial, sans-serif; font-size: 9px; padding: 10mm; width: 190mm;">
                <h1 style="font-size: 18px; color: #f97316;">प्रवास कार्यक्रम रिपोर्ट</h1>
                <p><strong>कुल कार्यक्रम:</strong> ${filteredData.length}</p>
                <p><strong>रिपोर्ट दिनांक:</strong> ${new Date().toLocaleDateString('hi-IN')}</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead style="background-color: #f2f2f2;">
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 4px;">क्र.</th>
                            <th style="border: 1px solid #ddd; padding: 4px;">कार्यक्रम</th>
                            <th style="border: 1px solid #ddd; padding: 4px;">मंडल</th>
                            <th style="border: 1px solid #ddd; padding: 4px;">प्रकार</th>
                            <th style="border: 1px solid #ddd; padding: 4px;">दिनांक</th>
                            <th style="border: 1px solid #ddd; padding: 4px;">उपस्थिति</th>
                        </tr>
                    </thead>
                    <tbody>`;
            filteredData.forEach((p, index) => {
                reportHtml += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 4px;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 4px;">${p['कार्यक्रम का नाम']}</td>
                        <td style="border: 1px solid #ddd; padding: 4px;">${p['मंडल का नाम']}</td>
                        <td style="border: 1px solid #ddd; padding: 4px;">${p['कार्यक्रम का प्रकार']}</td>
                        <td style="border: 1px solid #ddd; padding: 4px;">${p['कार्यक्रम दिनांक']}</td>
                        <td style="border: 1px solid #ddd; padding: 4px;">${p['कार्यक्रम में कुल उपस्तिथि']}</td>
                    </tr>`;
            });
            reportHtml += `</tbody></table></div>`;
            
            element.innerHTML = reportHtml;
            document.body.appendChild(element);

            await pdf.html(element, {
                callback: function(doc) {
                    doc.save('कार्यक्रम_रिपोर्ट.pdf');
                    document.body.removeChild(element);
                },
                x: 0,
                y: 0,
                width: 210,
                windowWidth: element.scrollWidth
            });
        }

        // --- Dashboard ---
        function processAndRenderDashboard() {
            const analytics = { byMandal: {}, byType: {}, byDate: {}, totalAttendance: 0 };
            programData.forEach(p => {
                if(p['मंडल का नाम']) analytics.byMandal[p['मंडल का नाम']] = (analytics.byMandal[p['मंडल का नाम']] || 0) + 1;
                if(p['कार्यक्रम का प्रकार']) analytics.byType[p['कार्यक्रम का प्रकार']] = (analytics.byType[p['कार्यक्रम का प्रकार']] || 0) + 1;
                const dateParts = (p['कार्यक्रम दिनांक'] || '').split('/');
                if (dateParts.length === 3) {
                    const date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    if(!isNaN(new Date(date))) {
                       analytics.byDate[date] = (analytics.byDate[date] || 0) + 1;
                    }
                }
                analytics.totalAttendance += parseInt(p['कार्यक्रम में कुल उपस्तिथि']) || 0;
            });
            
            document.getElementById('total-programs').textContent = programData.length;
            document.getElementById('total-mandals').textContent = Object.keys(analytics.byMandal).length;
            document.getElementById('total-attendance').textContent = analytics.totalAttendance;
            
            renderPieChart(analytics.byType, 'typesChart', 'कार्यक्रम के प्रकार');
            renderBarChart(analytics.byMandal, 'mandalsChart', 'मंडल अनुसार कार्यक्रम');
            renderLineChart(analytics.byDate, 'timelineChart', 'समयरेखा पर कार्यक्रम');
        }

        function renderPieChart(data, canvasId, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ label: label, data: Object.values(data), backgroundColor: ['#f97316', '#fb923c', '#fdba74', '#fed7aa', '#ffedd5'], hoverOffset: 4 }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: label, font: { size: 16 } } } }
            });
        }
        
        function renderBarChart(data, canvasId, label) {
            const sortedData = Object.entries(data).sort(([,a],[,b]) => b-a);
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(item => item[0]),
                    datasets: [{ label: label, data: sortedData.map(item => item[1]), backgroundColor: '#fb923c', borderColor: '#f97316', borderWidth: 1 }]
                },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false }, title: { display: true, text: label, font: { size: 16 } } } }
            });
        }
        
        function renderLineChart(data, canvasId, label) {
            const sortedDates = Object.keys(data).sort();
            const chartData = sortedDates.map(date => ({x: date, y: data[date]}));
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{ label: label, data: chartData, fill: true, backgroundColor: 'rgba(251, 146, 60, 0.2)', borderColor: '#f97316', tension: 0.1 }]
                },
                options: { scales: { x: { type: 'time', time: { unit: 'month', tooltipFormat: 'dd/MM/yyyy' } } }, plugins: { legend: { display: false }, title: { display: true, text: label, font: { size: 16 } } } }
            });
        }
        
        // --- Slideshow ---

        function generateSlideshowData() {
            slideshowData = [];
            filteredData.forEach(program => {
                const photoLinks = (program['कार्यक्रम के फोटो'] || '').split(',').map(link => link.trim()).filter(link => link);
                if (photoLinks.length > 0) {
                    photoLinks.forEach((link, index) => {
                        const fileId = getDriveFileId(link);
                        if (fileId) {
                            slideshowData.push({
                                ...program,
                                currentPhotoUrl: `https://lh3.googleusercontent.com/d/${fileId}`,
                                photoIndex: index + 1,
                                totalPhotos: photoLinks.length
                            });
                        }
                    });
                } else {
                    // Add program even if it has no photos, for completeness
                    slideshowData.push({
                        ...program,
                        currentPhotoUrl: 'https://placehold.co/800x600/1e293b/94a3b8?text=फोटो+नहीं',
                        photoIndex: 0,
                        totalPhotos: 0
                    });
                }
            });
        }

        function startSlideshow() {
            if (slideshowData.length === 0) {
                alert('दिखाने के लिए कोई कार्यक्रम नहीं है।');
                return;
            }
            document.getElementById('slideshow-overlay').classList.remove('hidden');
            document.getElementById('slideshow-overlay').classList.add('flex');
            slideshowIndex = 0;
            isSlideshowPaused = false;
            updateSlideshowPauseIcon();
            renderSlide();
            slideshowInterval = setInterval(nextSlide, 7000);
        }

        function stopSlideshow() {
            document.getElementById('slideshow-overlay').classList.add('hidden');
            document.getElementById('slideshow-overlay').classList.remove('flex');
            clearInterval(slideshowInterval);
        }

        function renderSlide() {
            if (slideshowData.length === 0) { stopSlideshow(); return; }
            const slideItem = slideshowData[slideshowIndex];
            const content = document.getElementById('slideshow-content');
            
            let photoCounterHtml = '';
            if (slideItem.totalPhotos > 0) {
                photoCounterHtml = `<div class="absolute top-4 left-4 bg-black/50 text-white text-sm font-bold px-3 py-1 rounded-full">फोटो ${slideItem.photoIndex} / ${slideItem.totalPhotos}</div>`;
            }

            content.innerHTML = `
                <div class="slideshow-card w-full h-full flex flex-col md:flex-row items-center justify-center gap-8 text-white">
                    <div class="relative w-full md:w-1/2 h-1/2 md:h-3/4">
                        <img src="${slideItem.currentPhotoUrl}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/800x600/1e293b/94a3b8?text=फोटो+उपलब्ध+नहीं';" 
                             alt="${slideItem['कार्यक्रम का नाम']}" class="w-full h-full object-contain rounded-2xl shadow-2xl">
                        ${photoCounterHtml}
                    </div>
                    <div class="w-full md:w-1/2 text-center md:text-left">
                        <p class="text-xl text-orange-400 font-semibold">${slideItem['कार्यक्रम का प्रकार']}</p>
                        <h2 class="text-4xl lg:text-6xl font-bold my-4 hindi-title">${slideItem['कार्यक्रम का नाम']}</h2>
                        <p class="text-lg text-gray-300 mt-2"><strong>मंडल:</strong> ${slideItem['मंडल का नाम']}</p>
                        <p class="text-lg text-gray-300"><strong>दिनांक:</strong> ${slideItem['कार्यक्रम दिनांक']}</p>
                        <p class="text-lg text-gray-300"><strong>उपस्थिति:</strong> ${slideItem['कार्यक्रम में कुल उपस्तिथि']}</p>
                    </div>
                </div>
            `;
        }
        
        function nextSlide() {
            slideshowIndex = (slideshowIndex + 1) % slideshowData.length;
            renderSlide();
        }

        function prevSlide() {
            slideshowIndex = (slideshowIndex - 1 + slideshowData.length) % slideshowData.length;
            renderSlide();
            clearInterval(slideshowInterval); // Stop auto-play when user navigates manually
            isSlideshowPaused = true;
            updateSlideshowPauseIcon();
        }

        function toggleSlideshowPause() {
            isSlideshowPaused = !isSlideshowPaused;
            if (isSlideshowPaused) {
                clearInterval(slideshowInterval);
            } else {
                nextSlide(); // Show next slide immediately and then set interval
                slideshowInterval = setInterval(nextSlide, 7000);
            }
            updateSlideshowPauseIcon();
        }
        
        function updateSlideshowPauseIcon() {
            document.getElementById('pause-icon').classList.toggle('hidden', isSlideshowPaused);
            document.getElementById('play-icon').classList.toggle('hidden', !isSlideshowPaused);
        }

    </script>
</body>
</html>

